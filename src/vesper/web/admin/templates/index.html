## -*- coding: utf-8 -*-
<%namespace name='layout' file="layout.html" />
<%!
from vesper.backports import json
%>

<%layout:layout>

  <%def name="head()">
  <title>vesper admin</title>
  </%def>

  <%def name="style()">
  ${layout.panelCss()}
  .ui-icon-refresh {
      display:none;
  }
  .panel-queryarea {
      background-color: whitesmoke;
      padding: 6px;
      padding-bottom: 12px; 
      margin-bottom:12px;
      overflow-y: hidden;
      -moz-border-radius-bottomleft: 5px;
      -moz-border-radius-bottomright: 5px;    
      -webkit-border-bottom-left-radius: 5px;
      -webkit-border-bottom-right-radius: 5px;        

      -moz-box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
      -webkit-box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
  }
  #query {
    width: 100%;
  }
  .query-options {
      float:right;
      padding-right:20px;
  }
  .resultbox {
      padding: 6px;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;        

      -moz-box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
      -webkit-box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
  }
  #error {
    display:none;
    background-color:lightsalmon;
    margin-top: 12px;
    margin-bottom: 12px;
  }  
  #explainresults {
    display:none;
    background-color:palegreen;
    margin-top: 12px;
  }
  #debugresults {
    display:none;
    background-color:lightsteelblue;
    margin-top: 12px;
  }
  </%def>

  <%def name="sidebar()">
      sidebar!!!
  </%def>

  <%layout:renderPanel panelId="main-panel">
    <%def name='headerContents()'>
    Query&nbsp;<span id="headerquery"></span>
    </%def>
  <div id="queryinput" class="panel-queryarea">
  Enter your query: <textarea id='query'></textarea>
  <button id='query-button'>Go</button>
  <div class="query-options">
    <label><input type="checkbox" id="opt-explain">Explain</label>&nbsp;&nbsp;
    <label><input type="checkbox" id="opt-forupdate">For Update</label>
    <label><input type="checkbox" id="opt-debug">Debug</label>    
  </div>
  </div>
  <div id='error' class="resultbox">
  <b>Error:</b><hr>
  <div class="precontent">&nbsp;</div>
  </div>  
  <b>Results:</b>
  <div id='queryresults' class="precontent">
  </div>
  <div id='explainresults' class="resultbox">
  <b>Explain:</b><hr>
  <div class="precontent">&nbsp;</div>
  </div>
  <div id='debugresults' class="resultbox">
  <b>Debug:</b><hr>
  <div class="precontent">&nbsp;</div>
  </div>  
  </%layout:renderPanel>

  <%def name="script()">
    <script type='text/javascript'>
      <%layout:initPanelJs></%layout:initPanelJs>
      
      $(document).ready(function(){
          $('#query-button').click(function() {
              var q = {captureErrors:true};
              q.query = $('#query').val();
              q.explain = $('#opt-explain').is(':checked');
              q.forUpdate = $('#opt-forupdate').is(':checked');
              q.debug = $('#opt-debug').is(':checked');
              $('#queryresults').dbQuery(q, function(data) {
                  if (data.results) {
                      $('#queryresults').text(JSON.stringify(data.results, null, 4));                      
                      $('#headerquery').text(" - Showing " + data.results.length + " objects");                        
                  }
                  if (data.errors && data.errors.length > 0) {
                      $('#error .precontent').text(JSON.stringify(data.errors, null, 4));
                      $('#error').show();
                  } else {
                      $('#error').hide();
                  }
                  if (data.explain) {
                      $('#explainresults .precontent').text(data.explain);
                      $('#explainresults').show();
                  } else {
                      $('#explainresults').hide();
                  }
                  if (data.debug) {
                      $('#debugresults .precontent').text(data.debug);
                      $('#debugresults').show();
                  } else {
                      $('#debugresults').hide();                      
                  }
              });
          });
      });
      
    </script>
  </%def>

</%layout:layout>